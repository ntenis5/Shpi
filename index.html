<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prona në Glob</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: white;
    }
    #globeViz {
      position: absolute;
      width: 100vw;
      height: 100vh;
    }
    #filterPanel, #adminPanel {
      position: absolute;
      top: 70px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      display: none;
      z-index: 10;
    }
    .top-button {
      position: absolute;
      top: 10px;
      padding: 8px 16px;
      background: orange;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 10;
    }
    #saleBtn { left: 10px; }
    #searchToggle { left: 80px; }
    #rentBtn { left: 160px; }
    #startBtn {
      right:  15%;
      transform: translateX(-50%);
      background: green;
      color: white;
    }
    #adminToggle {
      right: 0px;
      background: crimson;
      color: white;
    }
    #resetBtn {
      right: 120px;
      background: gray;
      color: white;
      display: none;
    }
    #categoryCircle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 500px;
      height: 500px;
      margin-left: -250px;
      margin-top: -250px;
      pointer-events: none;
      z-index: 5;
    }
    .orbit-button {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: orange;
      color: black;
      font-weight: bold;
      border: none;
      pointer-events: auto;
      cursor: pointer;
    }
    .orbit-button:hover {
      background: darkorange;
    }
    input, select {
      width: 100%;
      margin-bottom: 5px;
      padding: 6px;
      border-radius: 5px;
      border: none;
    }
    button {
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>

  <!-- Buttons -->
  <button id="saleBtn" class="top-button">Sale</button> 
  <button id="searchToggle" class="top-button">Search</button> 
  <button id="rentBtn" class="top-button">Rent</button> 
  <button id="adminToggle" class="top-button">Admin</button> 
  <button id="startBtn" class="top-button">START</button> 
  <button id="resetBtn" class="top-button">Rifillo</button>

  <!-- Filters -->
  <div id="filterPanel">
    <select id="filter-category"><option value="">Të gjitha kategoritë</option></select>
    <input type="text" id="filter-city" placeholder="Qyteti / Shteti" />
    <input type="number" id="filter-price" placeholder="Çmimi max" />
    <input type="number" id="filter-min-price" placeholder="Çmimi min" />
    <select id="filter-sort">
      <option value="">Rendit sipas</option>
      <option value="asc">Çmimi në rritje</option>
      <option value="desc">Çmimi në zbritje</option>
    </select>
    <button onclick="applyFilters()">Filtro</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h4>Shto Pronë</h4>
    <input type="text" id="new-category" placeholder="Kategoria" />
    <input type="text" id="new-city" placeholder="Qyteti/Shteti" />
    <input type="number" id="new-price" placeholder="Çmimi" />
    <input type="number" id="new-lat" placeholder="Gjerësia (lat)" />
    <input type="number" id="new-lng" placeholder="Gjatësia (lng)" />
    <label>
      Tipi i pronës:
      <select id="new-type">
        <option value="sale">Në shitje</option>
        <option value="rent">Me qira</option>
      </select>
    </label>
    <button onclick="addProperty()">Publiko</button>
  </div>

  <!-- Orbit categories -->
  <div id="categoryCircle">
    <button class="orbit-button" onclick="filterByCategory('Shtëpi')">Shtëpi</button>
    <button class="orbit-button" onclick="filterByCategory('Vilë')">Vilë</button>
    <button class="orbit-button" onclick="filterByCategory('Apartament')">Apartament</button>
    <button class="orbit-button" onclick="filterByCategory('Magazinë')">Magazinë</button>
    <button class="orbit-button" onclick="filterByCategory('Kapanon')">Kapanon</button>
    <button class="orbit-button" onclick="filterByCategory('Parking')">Parking</button>
    <button class="orbit-button" onclick="filterByCategory('Parcelë')">Parcelë</button>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAzeg2ha8agdS5zKFB34Udwj2CTMJamy0E",
      authDomain: "shpi-d4e2d.firebaseapp.com",
      projectId: "shpi-d4e2d",
      storageBucket: "shpi-d4e2d.appspot.com",
      messagingSenderId: "600471884377",
      appId: "1:600471884377:web:5512544dc9dfb1fa009748"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Firestore collection ref
    const propertyCol = collection(db, "properties");

    // Glob variables
    let allProperties = [];
    let selectedCategory = "";
    let selectedType = "";

    // Globe setup
    const globe = Globe()(document.getElementById('globeViz'))
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
      .backgroundColor('#000')
      .pointOfView({ lat: 20, lng: 0, altitude: 2 });

    // Render globe points & update category filter dropdown
    function renderPoints(data) {
      globe.pointsData(data)
        .pointLat(d => d.lat)
        .pointLng(d => d.lng)
        .pointAltitude(0.05)
        .pointColor(() => 'orange')
        .pointLabel(d => `${d.category}<br>${d.city}<br>€${d.price.toLocaleString('sq-AL')}`);

      updateCategoryFilter(data);
    }

    // Update category dropdown options dynamically
    function updateCategoryFilter(data) {
      const categories = [...new Set(data.map(p => p.category))];
      const select = document.getElementById("filter-category");
      select.innerHTML = '<option value="">Të gjitha kategoritë</option>';
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
    }

    // Apply filters on properties & render filtered points
    window.applyFilters = function () {
      const fCategory = document.getElementById("filter-category").value.toLowerCase();
      const fCity = document.getElementById("filter-city").value.toLowerCase();
      const fMax = parseFloat(document.getElementById("filter-price").value);
      const fMin = parseFloat(document.getElementById("filter-min-price").value);
      const sort = document.getElementById("filter-sort").value;

      let filtered = allProperties.filter(p => {
        return (!fCategory || p.category.toLowerCase().includes(fCategory)) &&
               (!fCity || p.city.toLowerCase().includes(fCity)) &&
               (!fMax || p.price <= fMax) &&
               (!fMin || p.price >= fMin);
      });

      if (sort === "asc") filtered.sort((a, b) => a.price - b.price);
      if (sort === "desc") filtered.sort((a, b) => b.price - a.price);

      renderPoints(filtered);
    }

    // Add new property to Firestore
    window.addProperty = async function () {
      try {
        const category = document.getElementById("new-category").value.trim();
        const city = document.getElementById("new-city").value.trim();
        const price = parseFloat(document.getElementById("new-price").value);
        const lat = parseFloat(document.getElementById("new-lat").value);
        const lng = parseFloat(document.getElementById("new-lng").value);
        const type = document.getElementById("new-type").value;

        if (!category || !city || isNaN(price) || isNaN(lat) || isNaN(lng)) {
          alert("Plotëso të gjitha fushat.");
          return;
        }

        const newProp = { category, city, price, lat, lng, type };
        await addDoc(propertyCol, newProp);
        alert("Prona u shtua me sukses!");

        // Pas shtimit, fshij fushat e formularit
        document.getElementById("new-category").value = "";
        document.getElementById("new-city").value = "";
        document.getElementById("new-price").value = "";
        document.getElementById("new-lat").value = "";
        document.getElementById("new-lng").value = "";

        // Nuk duhet të shtojmë manualisht në allProperties sepse onSnapshot do rifreskojë automatikisht
      } catch (err) {
        console.error(err);
        alert("Gabim gjatë shtimit.");
      }
    }

    // Filter by category button click
    window.filterByCategory = function(cat) {
      selectedCategory = cat;
      document.getElementById("filter-category").value = cat;
    }

    // Button handlers for Sale / Rent
    document.getElementById('saleBtn').onclick = () => {
      selectedType = "sale";
      document.getElementById('saleBtn').style.background = "darkorange";
      document.getElementById('rentBtn').style.background = "orange";
    };
    document.getElementById('rentBtn').onclick = () => {
      selectedType = "rent";
      document.getElementById('rentBtn').style.background = "darkorange";
      document.getElementById('saleBtn').style.background = "orange";
    };

    // Start filtering based on selected category & type
    document.getElementById('startBtn').onclick = () => {
      let filtered = allProperties;

      if (selectedType) filtered = filtered.filter(p => p.type === selectedType);
      if (selectedCategory) filtered = filtered.filter(p => p.category === selectedCategory);

      renderPoints(filtered);

      document.getElementById('saleBtn').style.display = 'none';
      document.getElementById('rentBtn').style.display = 'none';
      document.getElementById('searchToggle').style.display = 'none';
      document.getElementById('categoryCircle').style.display = 'none';
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'block';
    };

    // Reset filters and UI
    document.getElementById('resetBtn').onclick = () => {
      selectedType = '';
      selectedCategory = '';
      renderPoints(allProperties);

      document.getElementById('saleBtn').style.background = "orange";
      document.getElementById('rentBtn').style.background = "orange";

      document.getElementById('saleBtn').style.display = 'block';
      document.getElementById('rentBtn').style.display = 'block';
      document.getElementById('searchToggle').style.display = 'block';
      document.getElementById('categoryCircle').style.display = 'block';
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('resetBtn').style.display = 'none';

      // Also clear filters UI
      document.getElementById("filter-category").value = "";
      document.getElementById("filter-city").value = "";
      document.getElementById("filter-price").value = "";
      document.getElementById("filter-min-price").value = "";
      document.getElementById("filter-sort").value = "";
    };

    // Toggle search panel
    document.getElementById('searchToggle').onclick = () => {
      const panel = document.getElementById('filterPanel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    };

    // Position orbit buttons in circle
    const orbitButtons = document.querySelectorAll('.orbit-button');
    const radius = 160;
    orbitButtons.forEach((btn, i) => {
      const angle = (i / orbitButtons.length) * 2 * Math.PI;
      const x = Math.cos(angle) * radius;
      const y = Math.sin(angle) * radius;
      btn.style.left = `${250 + x - 50}px`;
      btn.style.top = `${250 + y - 50}px`;
    });

    // Firebase Authentication - Admin login/logout logic
    function showAdminPanel() {
      document.getElementById
