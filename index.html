<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prona në Glob</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: white;
    }
    #globeViz {
      position: absolute;
      width: 100vw;
      height: 100vh;
    }
    #filterPanel, #adminPanel {
      position: absolute;
      top: 70px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      display: none;
      z-index: 10;
      max-width: 300px;
    }
    .top-button {
      position: absolute;
      top: 10px;
      padding: 8px 16px;
      background: orange;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 20;
      user-select: none;
    }
    #saleBtn { left: 10px; }
    #searchToggle { left: 80px; }
    #rentBtn { left: 170px; }
    #startBtn {
      right: 20px;
      background: green;
      color: white;
    }
    #resetBtn {
      right: 10px;
      background: gray;
      color: white;
      display: none;
    }
    #adminToggle {
      right: 0px;
      background: crimson;
      color: white;
    }
    #categoryCircle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 400px;
      height: 400px;
      margin-left: -200px;
      margin-top: -200px;
      pointer-events: none;
      z-index: 5;
    }
    .orbit-button {
      position: absolute;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: orange;
      color: black;
      font-weight: bold;
      border: none;
      pointer-events: auto;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    .orbit-button:hover {
      background: darkorange;
    }
    input, select {
      width: 100%;
      margin-bottom: 7px;
      padding: 6px;
      border-radius: 5px;
      border: none;
    }
    button {
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>

  <!-- Buttons -->
  <button id="saleBtn" class="top-button">Sale</button> 
  <button id="searchToggle" class="top-button">Search</button> 
  <button id="rentBtn" class="top-button">Rent</button> 
  <button id="adminToggle" class="top-button">Admin</button> 
  <button id="startBtn" class="top-button">START</button> 
  <button id="resetBtn" class="top-button">Rifillo</button>

  <!-- Filters -->
  <div id="filterPanel">
    <select id="filter-category"><option value="">Të gjitha kategoritë</option></select> 
    <input type="text" id="filter-city" placeholder="Qyteti / Shteti" /> 
    <input type="number" id="filter-min-price" placeholder="Çmimi min" />
    <input type="number" id="filter-price" placeholder="Çmimi max" /> 
    <select id="filter-sort"> 
      <option value="">Rendit sipas</option> 
      <option value="asc">Çmimi në rritje</option> 
      <option value="desc">Çmimi në zbritje</option> 
    </select> 
    <button id="applyFilterBtn">Filtro</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h4>Shto Pronë</h4>
    <input type="text" id="new-category" placeholder="Kategoria" />
    <input type="text" id="new-city" placeholder="Qyteti/Shteti" />
    <input type="number" id="new-price" placeholder="Çmimi" />
    <input type="number" id="new-lat" placeholder="Gjerësia (lat)" />
    <input type="number" id="new-lng" placeholder="Gjatësia (lng)" />
    <label>Tipi i pronës:
      <select id="new-type">
        <option value="sale">Në shitje</option>
        <option value="rent">Me qira</option>
      </select>
    </label>
    <button id="addPropertyBtn">Publiko</button>
    <hr />
    <button id="logoutBtn">Dil nga admin</button>
  </div>

  <!-- Orbit categories -->
  <div id="categoryCircle">
    <button class="orbit-button" style="top:10%; left:50%" onclick="filterByCategory('Shtëpi')">Shtëpi</button>
    <button class="orbit-button" style="top:30%; left:80%" onclick="filterByCategory('Vilë')">Vilë</button>
    <button class="orbit-button" style="top:65%; left:85%" onclick="filterByCategory('Apartament')">Apartament</button>
    <button class="orbit-button" style="top:85%; left:55%" onclick="filterByCategory('Magazinë')">Magazinë</button>
    <button class="orbit-button" style="top:70%; left:20%" onclick="filterByCategory('Kapanon')">Kapanon</button>
    <button class="orbit-button" style="top:35%; left:15%" onclick="filterByCategory('Parking')">Parking</button>
    <button class="orbit-button" style="top:50%; left:40%" onclick="filterByCategory('Parcelë')">Parcelë</button>
  </div>

  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAzeg2ha8agdS5zKFB34Udwj2CTMJamy0E",
      authDomain: "shpi-d4e2d.firebaseapp.com",
      projectId: "shpi-d4e2d",
      storageBucket: "shpi-d4e2d.appspot.com",
      messagingSenderId: "600471884377",
      appId: "1:600471884377:web:5512544dc9dfb1fa009748"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const propertyCol = collection(db, "properties");
    let allProperties = [];
    let selectedCategory = "";
    let selectedType = "";

    const globe = Globe()(document.getElementById('globeViz'))
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
      .backgroundColor('#000')
      .pointOfView({ lat: 20, lng: 0, altitude: 2 });

    async function loadProperties() {
      const snapshot = await getDocs(propertyCol);
      allProperties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPoints(allProperties);
      updateCategoryFilter(allProperties);
    }

    function renderPoints(data) {
      globe.pointsData(data)
        .pointLat(d => d.lat)
        .pointLng(d => d.lng)
        .pointAltitude(0.05)
        .pointColor(() => 'orange')
        .pointLabel(d => `
          <b>Kategori:</b> ${d.category}<br>
          <b>Qytet:</b> ${d.city}<br>
          <b>Çmimi:</b> €${d.price.toLocaleString('sq-AL')}
        `);
    }

    function updateCategoryFilter(data) {
      const categories = [...new Set(data.map(p => p.category))].sort();
      const select = document.getElementById("filter-category");
      select.innerHTML = '<option value="">Të gjitha kategoritë</option>';
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
    }

    function applyFilters() {
      const fCategory = document.getElementById("filter-category").value.trim().toLowerCase();
      const fCity = document.getElementById("filter-city").value.trim().toLowerCase();
      const fMin = parseFloat(document.getElementById("filter-min-price").value);
      const fMax = parseFloat(document.getElementById("filter-price").value);
      const sort = document.getElementById("filter-sort").value;

      let filtered = allProperties.filter(p => {
        let matchCategory = !fCategory || p.category.toLowerCase().includes(fCategory);
        let matchCity = !fCity || p.city.toLowerCase().includes(fCity);
        let matchMin = isNaN(fMin) || p.price >= fMin;
        let matchMax = isNaN(fMax) || p.price <= fMax;
        return matchCategory && matchCity && matchMin && matchMax;
      });

      if (sort === "asc") filtered.sort((a,b) => a.price - b.price);
      else if (sort === "desc") filtered.sort((a,b) => b.price - a.price);

      renderPoints(filtered);
      showReset(true);
    }

    function filterByCategory(cat) {
      selectedCategory = cat;
      const filtered = allProperties.filter(p => p.category === selectedCategory);
      renderPoints(filtered);
      showReset(true);
    }

    // Show/hide filter panel
    const searchToggle = document.getElementById("searchToggle");
    const filterPanel = document.getElementById("filterPanel");
    searchToggle.onclick = () => {
      if(filterPanel.style.display === "block") {
        filterPanel.style.display = "none";
      } else {
        filterPanel.style.display = "block";
        adminPanel.style.display = "none";
      }
    }

    // Admin panel toggle
    const adminToggle = document.getElementById("adminToggle");
    const adminPanel = document.getElementById("adminPanel");
    adminToggle.onclick = () => {
      if(adminPanel.style.display === "block") {
        adminPanel.style.display = "none";
      } else {
        adminPanel.style.display = "block";
        filterPanel.style.display = "none";
      }
    }

    // Sale and Rent buttons select type filter
    document.getElementById('saleBtn').onclick = () => {
      selectedType = "sale";
      alert("Tipi: Në shitje");
    };
    document.getElementById('rentBtn').onclick = () => {
      selectedType = "rent";
      alert("Tipi: Me qira");
    };

    // START button filter by selected type and category
    document.getElementById('startBtn').onclick = () => {
      let filtered = allProperties;

      if(selectedType) {
        filtered = filtered.filter(p => p.type === selectedType);
      }
      if(selectedCategory) {
        filtered = filtered.filter(p => p.category === selectedCategory);
      }

      renderPoints(filtered);
      showReset(true);

      // Hide orbit circle and top filter buttons
      document.getElementById('categoryCircle').style.pointerEvents = "none";
      document.getElementById('categoryCircle').style.opacity = 0.3;
      document.getElementById('saleBtn').style.display = "none";
      document.getElementById('rentBtn').style.display = "none";
      document.getElementById('searchToggle').style.display = "none";
    };

    // Reset button to reload all points and show buttons back
    const resetBtn = document.getElementById('resetBtn');
    resetBtn.onclick = () => {
      renderPoints(allProperties);
      selectedCategory = "";
      selectedType = "";
      resetBtn.style.display = "none";

      document.getElementById('categoryCircle').style.pointerEvents = "auto";
      document.getElementById('categoryCircle').style.opacity = 1;
      document.getElementById('saleBtn').style.display = "inline-block";
      document.getElementById('rentBtn').style.display = "inline-block";
      document.getElementById('searchToggle').style.display = "inline-block";

      filterPanel.style.display = "none";
      adminPanel.style.display = "none";

      clearFilterInputs();
    };

    // Show or hide reset button
    function showReset(show) {
      resetBtn.style.display = show ? "inline-block" : "none";
    }

    // Clear filter inputs
    function clearFilterInputs() {
      document.getElementById("filter-category").value = "";
      document.getElementById("filter-city").value = "";
      document.getElementById("filter-min-price").value = "";
      document.getElementById("filter-price").value = "";
      document.getElementById("filter-sort").value = "";
    }

    // Apply filter button click
    document.getElementById("applyFilterBtn").onclick = () => {
      applyFilters();
      filterPanel.style.display = "none";
    };

    // Add property function - adds to Firestore & local array
    document.getElementById("addPropertyBtn").onclick = async () => {
      const category = document.getElementById("new-category").value.trim();
      const city = document.getElementById("new-city").value.trim();
      const price = parseFloat(document.getElementById("new-price").value);
      const lat = parseFloat(document.getElementById("new-lat").value);
      const lng = parseFloat(document.getElementById("new-lng").value);
      const type = document.getElementById("new-type").value;

      if (!category || !city || isNaN(price) || isNaN(lat) || isNaN(lng)) {
        alert("Ju lutem plotësoni të gjitha fushat me të dhëna valide.");
        return;
      }

      try {
        const newProp = { category, city, price, lat, lng, type };
        const docRef = await addDoc(propertyCol, newProp);
        newProp.id = docRef.id;
        allProperties.push(newProp);
        alert("Prona u shtua me sukses!");
        renderPoints(allProperties);
        updateCategoryFilter(allProperties);
        adminPanel.style.display = "none";
      } catch (err) {
        console.error(err);
        alert("Gabim gjatë shtimit të pronës.");
      }
    };

    // Logout button - just hides admin for demo
    document.getElementById("logoutBtn").onclick = () => {
      adminPanel.style.display = "none";
      alert("U larguat nga paneli admin.");
    };

    // Filter by category function (called by orbit buttons)
    window.filterByCategory = (cat) => {
      selectedCategory = cat;
      let filtered = allProperties.filter(p => p.category === cat);
      renderPoints(filtered);
      showReset(true);
    };

    // Load properties on startup
    loadProperties();

  </script>
</body>
</html>
